version: "3"
services:

  web:
    image: "hub.egistic.kz/nginx:latest"
    restart: "always"
    expose:
      - "80"
    environment:
      - "DOMAIN_NAME=${DOMAIN_NAME}"
      - "PROXY_PASS=http://app:80"
    volumes:
      - "../nginx/conf.d:/etc/nginx/conf.d/templates"
      - /static:/static
      - media:/media
    networks:
      - "arys"
    labels:
      - "traefik.frontend.rule=Host:${DOMAIN_NAME}"
    command: /bin/bash -c "envsubst '$${DOMAIN_NAME} $${PROXY_PASS}' < /etc/nginx/conf.d/templates/arys.template > /etc/nginx/conf.d/default.conf && nginx -g 'daemon off;'"

  app:
    image: "hub.egistic.kz/tumar:latest"
    restart: "always"
    expose:
      - "80"
    networks:
      - "arys"
      - "postgis"
      - "rabbit"
    volumes:
      - "/nfs/storage/imgback_rasters:/imgback_rasters"
      - ".:/code"
      # - /static:/static
      - media:/code/media
    environment:
      - "DEFAULT_DB_HOST=db_default"
      - "DEFAULT_DB_PORT=5432"
      - "DEFAULT_DB_NAME=tumar"
      - "DEFAULT_DB_USER=docker"
      - "DEFAULT_DB_PASSWORD=docker"
      - DJANGO_SECRET_KEY=production
      - DJANGO_CONFIGURATION=Production
      - DJANGO_SETTINGS_MODULE=tumar.config.production
      - RABBITMQ_DEFAULT_USER=patriot
      - RABBITMQ_DEFAULT_PASS=GtzYz4ahBvR3THg6x89E7wpNDCtYGLCZt6LSqZNXWaerEqD3bdkxRqTjZ6DFjL6Z
    command: >
      bash -c "update-rc.d celerybeat defaults &&
              service celerybeat start &&
              service celeryd start &&
              ./manage.py collectstatic &&
              ./manage.py migrate &&
              ./manage.py compilemessages &&
              ./manage.py runserver 0.0.0.0:80"

# celery worker 
# -Q imagery_requests.handle_process_request // List of queues to enable for this worker, separated by comma. By default all configured queues are enabled.
# -l ERROR // Logging level, choose between DEBUG, INFO, WARNING, ERROR, CRITICAL, or FATAL.
# -n tumar_worker // Set custom hostname (e.g., ‘w1@%%h’). Expands: %%h (hostname), %%n (name) and %%d, (domain).
# -c 8 // Number of child processes processing the queue. The default is the number of CPUs available on your system.

networks:
  arys:
    external: true
  postgis:
    external: true
  rabbit:
    external:
      name: "rabbit"

volumes:
  media: